#!/usr/bin/env zsh
setopt no_nomatch

SIG=4
SINK='@DEFAULT_SINK@'
STEP='0.05' # = 5%

refresh() { pkill -RTMIN+$SIG slstatus 2>/dev/null }

case "$1" in
  up)   wpctl set-volume -l 2.0 "$SINK" "${STEP}+" ;;
  down) wpctl set-volume -l 2.0 "$SINK" "${STEP}-" ;;
  mute) wpctl set-mute "$SINK" toggle ;;
  check) notify-send -a Volume -r 9993 "$(wpctl get-volume "$SINK")" -t 1000; exit ;;
esac

refresh

vol="$(wpctl get-volume "$SINK")" || { echo " N/A"; exit 0; }

[[ $vol == *"[MUTED]"* ]] && { echo "  "; exit 0; }

# get numeric value like 0.54 → 54
num="${vol#Volume: }"
num="${num%% *}"
pct=$(( ${num%%.*} * 100 + 10#${num#*.} / (10 ** ${#${num#*.}} / 100) ))

if   (( pct > 100 )); then icon="!"
elif (( pct > 0 ));  then icon=""
else icon=""
fi

echo "$icon $pct%"
